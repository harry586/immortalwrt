name: "Universal Firmware Builder"

on:
  # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œå®Œå…¨æ§åˆ¶ç¼–è¯‘è¿‡ç¨‹
  workflow_dispatch:
    inputs:
      source_preset:
        description: 'é€‰æ‹©æºç åº“'
        required: true
        type: choice
        options:
          - immortalwrt
          - openwrt
          - lede
        default: 'immortalwrt'
      
      source_branch:
        description: 'æºç åˆ†æ”¯ (auto=è‡ªåŠ¨æ¨è)'
        required: true
        default: 'auto'
        type: string
        
      config_profile:
        description: 'è®¾å¤‡é…ç½®æ–‡ä»¶'
        required: true
        type: choice
        options:
          - configs/.config_rt-ac42u_immortalwrt
          - configs/.config_rt-acrh17_lede
          - configs/.config_x86-64_openwrt
          - configs/.config_default
        default: 'configs/.config_rt-ac42u_immortalwrt'
      
      enable_custom_features:
        description: 'å¯ç”¨è‡ªå®šä¹‰åŠŸèƒ½'
        required: false
        default: true
        type: boolean

env:
  TZ: "Asia/Shanghai"
  BUILD_TIMEOUT: 180

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    # ======================
    # é˜¶æ®µ1ï¼šç¯å¢ƒå‡†å¤‡
    # ======================
    - name: "ğŸ“¥ æ£€å‡ºé…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: config-repo

    - name: "ğŸ”§ è§£ææºç é…ç½®"
      id: source-config
      run: |
        cd config-repo
        echo "è¯»å–æºç åº“é…ç½®..."
        
        if [ ! -f "repositories.json" ]; then
          echo "âŒ é”™è¯¯: repositories.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        REPO_CONFIG=$(cat repositories.json)
        PRESET="${{ github.event.inputs.source_preset }}"
        
        # è·å–æºç URLå’Œåˆ†æ”¯
        SOURCE_URL=$(echo "$REPO_CONFIG" | jq -r ".$PRESET.url")
        DESCRIPTION=$(echo "$REPO_CONFIG" | jq -r ".$PRESET.description")
        
        # åˆ†æ”¯å¤„ç†
        BRANCH="${{ github.event.inputs.source_branch }}"
        if [ "$BRANCH" = "auto" ]; then
          BRANCH=$(echo "$REPO_CONFIG" | jq -r ".$PRESET.recommended_branch")
          echo "è‡ªåŠ¨é€‰æ‹©æ¨èåˆ†æ”¯: $BRANCH"
        fi
        
        echo "æºç åº“: $PRESET - $DESCRIPTION"
        echo "ä»“åº“URL: $SOURCE_URL"
        echo "ä½¿ç”¨åˆ†æ”¯: $BRANCH"
        
        echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
        echo "SOURCE_BRANCH=$BRANCH" >> $GITHUB_ENV

    - name: "ğŸ§¹ å‡†å¤‡æ„å»ºç¯å¢ƒ"
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-serial python3-setuptools rsync unzip zlib1g-dev file wget \
          jq

    # ======================
    # é˜¶æ®µ2ï¼šæºç è·å–å’Œåˆå§‹åŒ–
    # ======================
    - name: "ğŸ“¥ è·å–æºä»£ç "
      run: |
        echo "å…‹éš†æºç ä»“åº“: ${{ env.SOURCE_URL }}"
        git clone --depth 1 \
          --branch "${{ env.SOURCE_BRANCH }}" \
          "${{ env.SOURCE_URL }}" \
          source

    - name: "ğŸ”§ æºç åˆå§‹åŒ–"
      run: |
        cd source
        echo "åˆå§‹åŒ–æºç ..."
        
        # æ›´æ–°feeds
        if [ -f "feeds.conf" ] || [ -f "feeds.conf.default" ]; then
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feedsæ›´æ–°å®Œæˆ"
        fi

    # ======================
    # é˜¶æ®µ3ï¼šè‡ªå®šä¹‰åŠŸèƒ½é›†æˆ
    # ======================
    - name: "ğŸ¨ åº”ç”¨è‡ªå®šä¹‰é…ç½®"
      run: |
        cd source
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        CONFIG_FILE="../config-repo/${{ github.event.inputs.config_profile }}"
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
          exit 1
        fi
        
        cp "$CONFIG_FILE" .config
        echo "âœ… é…ç½®æ–‡ä»¶åº”ç”¨å®Œæˆ: ${{ github.event.inputs.config_profile }}"

    - name: "ğŸ› ï¸ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        SCRIPTS_DIR="../config-repo/custom-features/scripts"
        
        # æ‰§è¡Œdiy2.shè„šæœ¬
        if [ -f "$SCRIPTS_DIR/diy2.sh" ]; then
          echo "æ‰§è¡Œ diy2.sh è„šæœ¬..."
          chmod +x "$SCRIPTS_DIR/diy2.sh"
          bash "$SCRIPTS_DIR/diy2.sh"
          echo "âœ… diy2.sh æ‰§è¡Œå®Œæˆ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° diy2.sh è„šæœ¬"
        fi
        
        # æ‰§è¡Œå…¶ä»–è„šæœ¬
        for script in "$SCRIPTS_DIR"/*.sh; do
          if [ "$script" != "$SCRIPTS_DIR/diy2.sh" ] && [ -f "$script" ]; then
            echo "æ‰§è¡Œè„šæœ¬: $(basename "$script")"
            chmod +x "$script"
            bash "$script" || echo "âš ï¸ è„šæœ¬æ‰§è¡Œå¤±è´¥: $script"
          fi
        done

    - name: "ğŸ“¦ é›†æˆé¢„ç¼–è¯‘IPK"
      if: github.event.inputs.enable_custom_features == 'true'
      run: |
        cd source
        IPK_DIR="../config-repo/custom-features/prebuilt-ipks"
        
        if [ -d "$IPK_DIR" ] && [ "$(ls -A "$IPK_DIR"/*.ipk 2>/dev/null)" ]; then
          echo "å‘ç°é¢„ç¼–è¯‘IPKæ–‡ä»¶ï¼Œåˆ›å»ºè‡ªåŠ¨å®‰è£…å™¨..."
          
          # åˆ›å»ºIPKè‡ªåŠ¨å®‰è£…å™¨åŒ…
          mkdir -p package/utils/auto-ipk-installer
          cat > package/utils/auto-ipk-installer/Makefile << 'EOF'
include $(TOPDIR)/rules.mk

PKG_NAME:=auto-ipk-installer
PKG_VERSION:=1.0
PKG_RELEASE:=1

PKG_MAINTAINER:=Auto Installer
PKG_LICENSE:=MIT

include $(INCLUDE_DIR)/package.mk

define Package/auto-ipk-installer
  SECTION:=utils
  CATEGORY:=Utilities
  TITLE:=Auto IPK Installer
  DEPENDS:=+opkg
  PKGARCH:=all
endef

define Package/auto-ipk-installer/description
  Automatically installs prebuilt IPK packages during first boot.
endef

define Build/Compile
  true
endef

define Package/auto-ipk-installer/install
	$(INSTALL_DIR) $(1)/etc/init.d
	cat > $(1)/etc/init.d/auto-ipk-installer << 'SCRIPT'
#!/bin/sh /etc/rc.common
START=99
boot() {
    [ -f /tmp/ipk-installed ] && return 0
    echo "Starting automatic IPK installation..."
    sleep 10
    for ipk in /tmp/ipk-packages/*.ipk; do
        [ -f "$ipk" ] && opkg install "$ipk" && rm -f "$ipk"
    done
    rmdir /tmp/ipk-packages 2>/dev/null || true
    touch /tmp/ipk-installed
}
SCRIPT
	chmod +x $(1)/etc/init.d/auto-ipk-installer
	$(INSTALL_DIR) $(1)/etc/rc.d
	ln -sf ../init.d/auto-ipk-installer $(1)/etc/rc.d/S99auto-ipk-installer
endef

$(eval $(call BuildPackage,auto-ipk-installer))
EOF
          
          # å¤åˆ¶IPKæ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿ
          mkdir -p files/tmp/ipk-packages
          cp "$IPK_DIR"/*.ipk files/tmp/ipk-packages/ 2>/dev/null || true
          
          echo "âœ… é¢„ç¼–è¯‘IPKæ–‡ä»¶é›†æˆå®Œæˆ"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°é¢„ç¼–è¯‘IPKæ–‡ä»¶"
        fi

    # ======================
    # é˜¶æ®µ4ï¼šç¼–è¯‘è¿‡ç¨‹
    # ======================
    - name: "ğŸ—ï¸ ç¼–è¯‘å›ºä»¶"
      timeout-minutes: ${{ env.BUILD_TIMEOUT }}
      run: |
        cd source
        
        # è®¡ç®—å¹¶è¡Œä»»åŠ¡æ•°
        BUILD_JOBS=$(( $(nproc) - 1 ))
        [ $BUILD_JOBS -lt 1 ] && BUILD_JOBS=1
        echo "ä½¿ç”¨å¹¶è¡Œä»»åŠ¡æ•°: $BUILD_JOBS"
        
        START_TIME=$(date +%s)
        
        echo "å¼€å§‹ç¼–è¯‘è¿‡ç¨‹..."
        make defconfig
        make download -j${BUILD_JOBS} || make download -j1 V=s
        make -j${BUILD_JOBS} || make -j1 V=s
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "âœ… ç¼–è¯‘å®Œæˆ! è€—æ—¶: ${DURATION}ç§’"

    # ======================
    # é˜¶æ®µ5ï¼šè¾“å‡ºå¤„ç†
    # ======================
    - name: "ğŸ“¦ æ”¶é›†æ„å»ºäº§ç‰©"
      run: |
        cd source
        echo "æ”¶é›†ç¼–è¯‘è¾“å‡ºæ–‡ä»¶..."
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.trx" 2>/dev/null | head -10)
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ ‡å‡†å›ºä»¶æ–‡ä»¶"
        fi
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯
        cat > ../build-info.md << EOF
# æ„å»ºä¿¡æ¯
- æºç : ${{ env.SOURCE_URL }}
- åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}
- é…ç½®: ${{ github.event.inputs.config_profile }}
- æ—¶é—´: $(date)
- æ—¶é•¿: ${DURATION}ç§’
EOF

        # å‡†å¤‡äº§ç‰©
        mkdir -p ../artifacts
        cp -r bin/targets/* ../artifacts/ 2>/dev/null || true
        cp ../build-info.md ../artifacts/

    - name: "ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: "Firmware-${{ github.run_number }}"
        path: artifacts/
        retention-days: 30

    - name: "ğŸ“Š æ„å»ºæŠ¥å‘Š"
      if: always()
      run: |
        echo "=== æ„å»ºæŠ¥å‘Š ==="
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æºç : ${{ env.SOURCE_URL }}"
        echo "é…ç½®: ${{ github.event.inputs.config_profile }}"
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸ!"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
        fi